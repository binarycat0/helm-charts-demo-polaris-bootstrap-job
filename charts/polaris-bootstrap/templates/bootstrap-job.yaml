apiVersion: batch/v1
kind: Job
metadata:
  name: polaris-bootstrap-${TIMESTAMP}
  namespace: polaris
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    spec:
      restartPolicy: Never
      initContainers:
        - name: wait-for-polaris
          image: busybox:1.36
          command: ["sh", "-c", "until wget --spider -q http://polaris-mgmt:8182/q/health/ready; do sleep 5; done"]
      containers:
        - name: bootstrap
          image: apache/polaris-admin-tool:latest
          env:
            - name: QUARKUS_DATASOURCE_USERNAME
              valueFrom:
                secretKeyRef:
                  name: polaris-persistence
                  key: username
            - name: QUARKUS_DATASOURCE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: polaris-persistence
                  key: password
            - name: QUARKUS_DATASOURCE_JDBC_URL
              valueFrom:
                secretKeyRef:
                  name: polaris-persistence
                  key: jdbcUrl
          command: ["bootstrap"]
          args: ["-c", "${BOOTSTRAP_CREDENTIALS}", "-r", "${BOOTSTRAP_REALM}"]